<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distillation BTX - Système Complet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .gradient-bg {
            background: linear-gradient(-45deg, #0f172a, #1e3a8a, #3b82f6, #0ea5e9);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success { background: #10b981; color: white; }
        .notification.error { background: #ef4444; color: white; }
        .notification.info { background: #3b82f6; color: white; }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .gradient-bg { background: white !important; }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Navigation -->
    <nav class="glass text-white p-4 sticky top-0 z-50 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fas fa-industry text-3xl"></i>
                <div>
                    <h1 class="text-2xl font-bold">Distillation Multicomposants BTX</h1>
                    <p class="text-xs text-blue-200">Prof. BAKHER Zine Elabidine - PIC - UM6P</p>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- Simulation Form -->
        <div id="simulationSection" class="glass rounded-2xl p-8 mb-8 no-print">
            <h3 class="text-3xl font-bold text-white mb-6">
                <i class="fas fa-flask"></i> Configuration de la Simulation BTX
            </h3>

            <form id="simulationForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Composés -->
                    <div class="space-y-4">
                        <h4 class="text-xl font-bold text-white">
                            <i class="fas fa-atom"></i> Composés du Mélange
                        </h4>
                        
                        <div>
                            <label class="block text-white mb-2">Composé 1 (Léger)</label>
                            <select id="compound1" required class="w-full p-3 rounded-lg bg-white/90 text-gray-800 border-2 border-blue-300 focus:border-blue-500 outline-none">
                                <option value="benzene" selected>Benzène</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Composé 2 (Intermédiaire)</label>
                            <select id="compound2" required class="w-full p-3 rounded-lg bg-white/90 text-gray-800 border-2 border-blue-300 focus:border-blue-500 outline-none">
                                <option value="toluene" selected>Toluène</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Composé 3 (Lourd)</label>
                            <select id="compound3" required class="w-full p-3 rounded-lg bg-white/90 text-gray-800 border-2 border-blue-300 focus:border-blue-500 outline-none">
                                <option value="o-xylene" selected>o-Xylène</option>
                            </select>
                        </div>
                    </div>

                    <!-- Paramètres -->
                    <div class="space-y-4">
                        <h4 class="text-xl font-bold text-white">
                            <i class="fas fa-sliders-h"></i> Paramètres Opératoires
                        </h4>
                        
                        <div>
                            <label class="block text-white mb-2">Débit d'alimentation (kmol/h)</label>
                            <input type="number" id="feedFlow" value="100" min="1" step="1" required class="w-full p-3 rounded-lg bg-white/90 text-gray-800 border-2 border-blue-300 focus:border-blue-500 outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Composition de l'alimentation</label>
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="block text-white text-sm mb-1">z₁</label>
                                    <input type="number" id="z1" value="0.333" step="0.001" min="0" max="1" required class="w-full p-2 rounded-lg bg-white/90 text-gray-800 text-center border-2 border-blue-300 focus:border-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-white text-sm mb-1">z₂</label>
                                    <input type="number" id="z2" value="0.333" step="0.001" min="0" max="1" required class="w-full p-2 rounded-lg bg-white/90 text-gray-800 text-center border-2 border-blue-300 focus:border-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-white text-sm mb-1">z₃</label>
                                    <input type="number" id="z3" value="0.334" step="0.001" min="0" max="1" required class="w-full p-2 rounded-lg bg-white/90 text-gray-800 text-center border-2 border-blue-300 focus:border-blue-500 outline-none">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Pression (kPa)</label>
                            <input type="number" id="pressure" value="101.325" step="0.001" min="50" required class="w-full p-3 rounded-lg bg-white/90 text-gray-800 border-2 border-blue-300 focus:border-blue-500 outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Facteur de reflux (R/Rₘᵢₙ)</label>
                            <input type="number" id="refluxFactor" value="1.3" step="0.1" min="1" max="5" required class="w-full p-3 rounded-lg bg-white/90 text-gray-800 border-2 border-blue-300 focus:border-blue-500 outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Efficacité des plateaux</label>
                            <input type="number" id="efficiency" value="0.70" step="0.05" min="0.1" max="1" required class="w-full p-3 rounded-lg bg-white/90 text-gray-800 border-2 border-blue-300 focus:border-blue-500 outline-none">
                        </div>
                    </div>
                </div>

                <div class="flex justify-center space-x-4 mt-8">
                    <button type="submit" id="simulateBtn" class="bg-green-500 hover:bg-green-600 text-white px-12 py-4 rounded-full font-bold text-lg transition transform hover:scale-105 shadow-lg">
                        <i class="fas fa-play"></i> Lancer la Simulation
                    </button>
                    <button type="button" onclick="resetForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-4 rounded-full font-bold text-lg transition transform hover:scale-105 shadow-lg">
                        <i class="fas fa-redo"></i> Réinitialiser
                    </button>
                </div>
            </form>

            <div id="progressContainer" class="hidden mt-8">
                <div class="bg-white/20 rounded-full h-8 overflow-hidden">
                    <div id="progressBar" class="bg-green-500 h-full transition-all duration-500 flex items-center justify-center text-white font-bold" style="width: 0%">
                        <span id="progressPercent">0%</span>
                    </div>
                </div>
                <p id="progressText" class="text-white text-center mt-3 text-lg">Préparation...</p>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <!-- Header -->
            <div class="glass rounded-2xl p-6 mb-6 no-print">
                <div class="flex justify-between items-center">
                    <h3 class="text-3xl font-bold text-white">
                        <i class="fas fa-chart-bar"></i> Résultats de la Simulation BTX
                    </h3>
                    <div class="flex gap-3">
                        <button onclick="downloadPDF()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-bold transition">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                        <button onclick="editSimulation()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-bold transition">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                    </div>
                </div>
            </div>

            <!-- KPIs -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg p-6 text-center shadow-xl">
                    <div class="text-4xl font-bold text-blue-600" id="kpi-nmin">-</div>
                    <div class="text-sm text-gray-600 mt-2 font-semibold">N<sub>min</sub> (plateaux)</div>
                </div>
                <div class="bg-white rounded-lg p-6 text-center shadow-xl">
                    <div class="text-4xl font-bold text-green-600" id="kpi-nreal">-</div>
                    <div class="text-sm text-gray-600 mt-2 font-semibold">N<sub>réel</sub> (plateaux)</div>
                </div>
                <div class="bg-white rounded-lg p-6 text-center shadow-xl">
                    <div class="text-4xl font-bold text-purple-600" id="kpi-reflux">-</div>
                    <div class="text-sm text-gray-600 mt-2 font-semibold">Reflux</div>
                </div>
                <div class="bg-white rounded-lg p-6 text-center shadow-xl">
                    <div class="text-4xl font-bold text-orange-600" id="kpi-feed">-</div>
                    <div class="text-sm text-gray-600 mt-2 font-semibold">Plateau Alim.</div>
                </div>
            </div>

            <!-- 1. BILAN MATIÈRE -->
            <div class="bg-white rounded-2xl p-6 mb-6 shadow-xl">
                <h4 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-blue-500 pb-2">
                    <i class="fas fa-balance-scale text-blue-600"></i> 1. Bilans Matières (btx_bilan_matiere.png)
                </h4>
                <div id="chart1" style="width: 100%; height: 500px;"></div>
            </div>

            <!-- 2. RÉSULTATS SHORTCUT -->
            <div class="bg-white rounded-2xl p-6 mb-6 shadow-xl">
                <h4 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-green-500 pb-2">
                    <i class="fas fa-calculator text-green-600"></i> 2. Résultats Shortcut (btx_shortcut_results.png)
                </h4>
                <div id="chart2" style="width: 100%; height: 550px;"></div>
            </div>

            <!-- 3. PROFILS DE COMPOSITION -->
            <div class="bg-white rounded-2xl p-6 mb-6 shadow-xl">
                <h4 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-purple-500 pb-2">
                    <i class="fas fa-chart-line text-purple-600"></i> 3. Profils de Composition (btx_composition_profiles.png)
                </h4>
                <div id="chart3" style="width: 100%; height: 600px;"></div>
            </div>

            <!-- 4. PROFIL DE TEMPÉRATURE -->
            <div class="bg-white rounded-2xl p-6 mb-6 shadow-xl">
                <h4 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-red-500 pb-2">
                    <i class="fas fa-thermometer-half text-red-600"></i> 4. Profil de Température (btx_temperature_profile.png)
                </h4>
                <div id="chart4" style="width: 100%; height: 600px;"></div>
            </div>

            <!-- 5. ÉTUDE REFLUX -->
            <div class="bg-white rounded-2xl p-6 mb-6 shadow-xl">
                <h4 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-orange-500 pb-2">
                    <i class="fas fa-chart-area text-orange-600"></i> 5. Étude Paramétrique du Reflux (btx_etude_reflux.png)
                </h4>
                <div id="chart5" style="width: 100%; height: 550px;"></div>
            </div>

            <!-- Tableau récapitulatif -->
            <div class="bg-white rounded-2xl p-6 mb-6 shadow-xl">
                <h4 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-gray-500 pb-2">
                    <i class="fas fa-table text-gray-600"></i> Résultats Détaillés
                </h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-bold text-gray-700">Paramètre</th>
                                <th class="px-6 py-3 text-right text-sm font-bold text-gray-700">Valeur</th>
                                <th class="px-6 py-3 text-center text-sm font-bold text-gray-700">Unité</th>
                                <th class="px-6 py-3 text-left text-sm font-bold text-gray-700">Méthode</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let simulationResults = null;
        let currentSessionId = null;

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        document.getElementById('simulationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const z1 = parseFloat(document.getElementById('z1').value);
            const z2 = parseFloat(document.getElementById('z2').value);
            const z3 = parseFloat(document.getElementById('z3').value);
            const sum = z1 + z2 + z3;
            
            if (Math.abs(sum - 1.0) > 0.01) {
                showNotification('La somme des fractions molaires doit être égale à 1.0', 'error');
                return;
            }

            const data = {
                compounds: [
                    document.getElementById('compound1').value,
                    document.getElementById('compound2').value,
                    document.getElementById('compound3').value
                ],
                feed_flow: parseFloat(document.getElementById('feedFlow').value),
                feed_composition: [z1, z2, z3],
                pressure: parseFloat(document.getElementById('pressure').value) * 1000,
                reflux_factor: parseFloat(document.getElementById('refluxFactor').value),
                efficiency: parseFloat(document.getElementById('efficiency').value),
                recovery_LK: 0.95,
                recovery_HK: 0.95,
                feed_quality: 1.0
            };

            document.getElementById('simulateBtn').disabled = true;
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');

            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                if (progress <= 90) {
                    updateProgress(progress, getProgressMessage(progress));
                }
            }, 200);

            try {
                const response = await fetch('/api/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                clearInterval(progressInterval);

                if (result.success) {
                    updateProgress(100, 'Simulation terminée !');
                    setTimeout(() => {
                        displayResults(result.results);
                        showNotification('Simulation complétée avec succès !', 'success');
                    }, 500);
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }
            } catch (error) {
                clearInterval(progressInterval);
                console.error('Erreur:', error);
                showNotification(`Erreur: ${error.message}`, 'error');
                resetUI();
            }
        });

        function getProgressMessage(progress) {
            if (progress < 20) return 'Chargement des composés...';
            if (progress < 40) return 'Bilans matières...';
            if (progress < 60) return 'Méthodes simplifiées (Fenske, Underwood)...';
            if (progress < 80) return 'Génération des profils...';
            return 'Finalisation des visualisations...';
        }

        function updateProgress(percent, message) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressText').textContent = message;
        }

        function displayResults(results) {
            simulationResults = results;
            currentSessionId = results.session_id;

            document.getElementById('kpi-nmin').textContent = results.results.N_min.toFixed(1);
            document.getElementById('kpi-nreal').textContent = results.results.N_real;
            document.getElementById('kpi-reflux').textContent = results.results.R.toFixed(2);
            document.getElementById('kpi-feed').textContent = results.results.feed_stage;

            createChart1_BilanMatiere(results);
            createChart2_ShortcutResults(results);
            createChart3_CompositionProfiles(results);
            createChart4_TemperatureProfile(results);
            createChart5_RefluxStudy(results);
            createResultsTable(results);

            document.getElementById('results').classList.remove('hidden');
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('simulateBtn').disabled = false;
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function createChart1_BilanMatiere(results) {
            const data = [{
                x: ['Alimentation', 'Distillat', 'Résidu'],
                y: [results.feed_flow, results.results.D, results.results.B],
                type: 'bar',
                marker: { color: ['#3b82f6', '#10b981', '#ef4444'], line: { color: '#000', width: 2 }},
                text: [`${results.feed_flow.toFixed(1)} kmol/h`, `${results.results.D.toFixed(1)} kmol/h`, `${results.results.B.toFixed(1)} kmol/h`],
                textposition: 'outside',
                textfont: { size: 16, weight: 'bold' }
            }];

            const layout = {
                title: { text: 'Bilans Matières - Débits des Flux', font: { size: 20, weight: 'bold' }},
                xaxis: { title: 'Flux', titlefont: { size: 16, weight: 'bold' }},
                yaxis: { title: 'Débit (kmol/h)', titlefont: { size: 16, weight: 'bold' }},
                margin: { t: 80, b: 80, l: 80, r: 40 },
                paper_bgcolor: 'white',
                plot_bgcolor: '#f9fafb'
            };

            Plotly.newPlot('chart1', data, layout, {responsive: true, displaylogo: false, toImageButtonOptions: {filename: 'btx_bilan_matiere'}});
        }

        function createChart2_ShortcutResults(results) {
            const methods = ['Fenske<br>(N_min)', 'Underwood<br>(R_min)', 'Gilliland<br>(N_théo)', 'N réel', 'Kirkbride<br>(Plat. alim)'];
            const values = [
                results.results.N_min,
                results.results.R_min,
                results.results.N_real * results.results.efficiency,
                results.results.N_real,
                results.results.feed_stage
            ];

            const data = [{
                x: methods,
                y: values,
                type: 'bar',
                marker: { color: ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444'], line: { color: '#000', width: 2 }},
                text: values.map(v => v.toFixed(2)),
                textposition: 'outside',
                textfont: { size: 16, weight: 'bold' }
            }];

            const layout = {
                title: { text: 'Résultats des Méthodes Simplifiées', font: { size: 20, weight: 'bold' }},
                xaxis: { tickfont: { size: 14 }},
                yaxis: { title: 'Valeur', titlefont: { size: 16, weight: 'bold' }},
                margin: { t: 80, b: 100, l: 80, r: 40 },
                paper_bgcolor: 'white',
                plot_bgcolor: '#f9fafb'
            };

            Plotly.newPlot('chart2', data, layout, {responsive: true, displaylogo: false, toImageButtonOptions: {filename: 'btx_shortcut_results'}});
        }

        function createChart3_CompositionProfiles(results) {
            const N = results.results.N_real;
            const stages = Array.from({length: N}, (_, i) => i + 1);
            const feedStage = results.results.feed_stage;
            
            const profiles = stages.map((stage) => {
                const ratio = stage <= feedStage ? (stage - 1) / feedStage : (stage - feedStage) / (N - feedStage);
                const benzene = (stage <= feedStage ? (results.results.x_D[0] + ratio * (0.333 - results.results.x_D[0])) : (0.333 + ratio * (results.results.x_B[0] - 0.333))) * 100;
                const toluene = (stage <= feedStage ? (results.results.x_D[1] + ratio * (0.333 - results.results.x_D[1])) : (0.333 + ratio * (results.results.x_B[1] - 0.333))) * 100;
                const xylene = (stage <= feedStage ? (results.results.x_D[2] + ratio * (0.334 - results.results.x_D[2])) : (0.334 + ratio * (results.results.x_B[2] - 0.334))) * 100;
                return { stage, benzene, toluene, xylene };
            });

            const data = [
                { x: profiles.map(p => p.benzene), y: profiles.map(p => p.stage), name: 'Benzène', type: 'scatter', mode: 'lines+markers', line: { color: '#3b82f6', width: 3 }, marker: { size: 8 }},
                { x: profiles.map(p => p.toluene), y: profiles.map(p => p.stage), name: 'Toluène', type: 'scatter', mode: 'lines+markers', line: { color: '#10b981', width: 3 }, marker: { size: 8 }},
                { x: profiles.map(p => p.xylene), y: profiles.map(p => p.stage), name: 'o-Xylène', type: 'scatter', mode: 'lines+markers', line: { color: '#ef4444', width: 3 }, marker: { size: 8 }}
            ];

            const layout = {
                title: { text: 'Profils de Composition Phase Liquide', font: { size: 20, weight: 'bold' }},
                xaxis: { title: 'Fraction molaire (%)', titlefont: { size: 16, weight: 'bold' }, range: [0, 100] },
                yaxis: { title: 'Numéro de plateau', titlefont: { size: 16, weight: 'bold' }, autorange: 'reversed' },
                shapes: [{ type: 'line', x0: 0, x1: 100, y0: feedStage, y1: feedStage, line: { color: '#8b5cf6', width: 3, dash: 'dash' }}],
                annotations: [{ x: 50, y: feedStage, text: `Alimentation (Plateau ${feedStage})`, showarrow: true, arrowhead: 2, ax: 0, ay: -40, font: { size: 14, color: '#8b5cf6', weight: 'bold' }}],
                margin: { t: 80, b: 80, l: 80, r: 40 },
                paper_bgcolor: 'white',
                plot_bgcolor: '#f9fafb'
            };

            Plotly.newPlot('chart3', data, layout, {responsive: true, displaylogo: false, toImageButtonOptions: {filename: 'btx_composition_profiles'}});
        }

        function createChart4_TemperatureProfile(results) {
            const N = results.results.N_real;
            const stages = Array.from({length: N}, (_, i) => i + 1);
            const T_top = 80.1, T_bottom = 138.5;
            const temperatures = stages.map((s, i) => T_top + (T_bottom - T_top) * (i / (N - 1)));

            const data = [{ x: temperatures, y: stages, type: 'scatter', mode: 'lines+markers', line: { color: '#f59e0b', width: 4 }, marker: { size: 10, color: '#ea580c' }}];

            const layout = {
                title: { text: 'Profil de Température dans la Colonne', font: { size: 20, weight: 'bold' }},
                xaxis: { title: 'Température (°C)', titlefont: { size: 16, weight: 'bold' }},
                yaxis: { title: 'Numéro de plateau', titlefont: { size: 16, weight: 'bold' }, autorange: 'reversed' },
                shapes: [{ type: 'line', x0: T_top, x1: T_bottom, y0: results.results.feed_stage, y1: results.results.feed_stage, line: { color: '#8b5cf6', width: 3, dash: 'dash' }}],
                annotations: [
                    { x: T_top, y: 1, text: `Tête: ${T_top.toFixed(1)}°C`, showarrow: true, ax: 40, ay: -30, font: { size: 14, color: '#3b82f6', weight: 'bold' }},
                    { x: T_bottom, y: N, text: `Fond: ${T_bottom.toFixed(1)}°C`, showarrow: true, ax: -40, ay: 30, font: { size: 14, color: '#ef4444', weight: 'bold' }}
                ],
                margin: { t: 80, b: 80, l: 80, r: 40 },
                paper_bgcolor: 'white',
                plot_bgcolor: '#f9fafb'
            };

            Plotly.newPlot('chart4', data, layout, {responsive: true, displaylogo: false, toImageButtonOptions: {filename: 'btx_temperature_profile'}});
        }

        function createChart5_RefluxStudy(results) {
            const R_min = results.results.R_min;
            const N_min = results.results.N_min;
            const factors = Array.from({length: 20}, (_, i) => 1.1 + i * 0.095);
            
            const plateaux = factors.map(f => {
                const R = f * R_min;
                const X = (R - R_min) / (R + 1);
                const exponent = (1 + 54.4*X) * (X - 1) / ((11 + 117.2*X) * Math.sqrt(X));
                const Y = 1 - Math.exp(exponent);
                const N = N_min + Y / (1 - Y);
                return N / 0.70;
            });

            const data = [{
                x: factors,
                y: plateaux,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#3b82f6', width: 4 },
                marker: { size: 10 },
                name: 'Courbe N vs R/R_min'
            }];

            const layout = {
                title: { text: 'Effet du Rapport de Reflux sur le Nombre de Plateaux', font: { size: 20, weight: 'bold' }},
                xaxis: { title: 'R / R_min', titlefont: { size: 16, weight: 'bold' }},
                yaxis: { title: 'Nombre de plateaux réels', titlefont: { size: 16, weight: 'bold' }},
                shapes: [
                    { type: 'line', x0: 1.0, x1: 3.0, y0: N_min/0.70, y1: N_min/0.70, line: { color: '#ef4444', width: 2, dash: 'dash' }},
                    { type: 'line', x0: 1.3, x1: 1.3, y0: 0, y1: Math.max(...plateaux), line: { color: '#10b981', width: 2, dash: 'dash' }}
                ],
                annotations: [
                    { x: 2.5, y: N_min/0.70, text: `N_min = ${(N_min/0.70).toFixed(1)}`, showarrow: false, font: { size: 14, color: '#ef4444', weight: 'bold' }},
                    { x: 1.3, y: plateaux[4], text: 'R = 1.3×R_min<br>(optimal)', showarrow: true, ax: 40, ay: -40, font: { size: 14, color: '#10b981', weight: 'bold' }}
                ],
                margin: { t: 80, b: 80, l: 80, r: 40 },
                paper_bgcolor: 'white',
                plot_bgcolor: '#f9fafb'
            };

            Plotly.newPlot('chart5', data, layout, {responsive: true, displaylogo: false, toImageButtonOptions: {filename: 'btx_etude_reflux'}});
        }

        function createResultsTable(results) {
            const tableData = [
                ['N_min (Fenske)', results.results.N_min.toFixed(2), 'plateaux', 'Reflux total'],
                ['R_min (Underwood)', results.results.R_min.toFixed(3), '-', 'Reflux minimum'],
                ['θ (Underwood)', results.results.theta.toFixed(3), '-', 'Racine équation'],
                ['R opératoire', results.results.R.toFixed(3), '-', `${(results.results.R / results.results.R_min).toFixed(2)}× R_min`],
                ['N théorique', (results.results.N_real * results.results.efficiency).toFixed(1), 'plateaux', 'Gilliland'],
                ['Efficacité', `${(results.results.efficiency * 100).toFixed(0)}`, '%', 'Donnée'],
                ['N réel', results.results.N_real, 'plateaux', 'N_théo / Efficacité'],
                ['N rectification', results.results.N_R, 'plateaux', 'Kirkbride'],
                ['N épuisement', results.results.N_S, 'plateaux', 'Kirkbride'],
                ['Plateau alimentation', results.results.feed_stage, '-', 'Kirkbride'],
                ['Débit distillat (D)', results.results.D.toFixed(2), 'kmol/h', 'Bilan matière'],
                ['Débit résidu (B)', results.results.B.toFixed(2), 'kmol/h', 'Bilan matière'],
                ['α_avg (LK/HK)', results.results.alpha_avg.toFixed(3), '-', 'Volatilité relative']
            ];

            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = tableData.map((row, i) => `
                <tr class="${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                    <td class="px-6 py-4 font-semibold text-gray-900">${row[0]}</td>
                    <td class="px-6 py-4 text-right font-bold text-blue-600 text-lg">${row[1]}</td>
                    <td class="px-6 py-4 text-center text-gray-600">${row[2]}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${row[3]}</td>
                </tr>
            `).join('');
        }

        async function downloadPDF() {
            if (!currentSessionId) {
                showNotification('Aucune simulation disponible', 'error');
                return;
            }

            try {
                showNotification('Génération du PDF en cours...', 'info');
                
                const response = await fetch(`/api/generate_pdf/${currentSessionId}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la génération du PDF');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rapport_distillation_${currentSessionId}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification('PDF téléchargé avec succès !', 'success');
            } catch (error) {
                console.error('Erreur téléchargement PDF:', error);
                showNotification(`Erreur: ${error.message}`, 'error');
            }
        }

        function resetUI() {
            document.getElementById('simulateBtn').disabled = false;
            document.getElementById('progressContainer').classList.add('hidden');
        }

        function resetForm() {
            document.getElementById('simulationForm').reset();
            document.getElementById('results').classList.add('hidden');
            showNotification('Formulaire réinitialisé', 'info');
        }

        function editSimulation() {
            document.getElementById('results').classList.add('hidden');
            document.getElementById('simulationSection').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showNotification('Modifiez les paramètres', 'info');
        }
    </script>
</body>
</html>