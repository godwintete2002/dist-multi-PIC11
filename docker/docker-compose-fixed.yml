# =============================================================================
# Docker Compose SimplifiÃ© - Version qui Fonctionne
# =============================================================================
# Usage: docker-compose -f docker-compose-fixed.yml up -d
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Redis - Cache
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: distillation-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass changeme123
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - distillation-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ---------------------------------------------------------------------------
  # Application Web
  # ---------------------------------------------------------------------------
  web:
    image: python:3.11-slim
    container_name: distillation-web
    restart: unless-stopped
    working_dir: /app
    command: >
      bash -c "
        apt-get update && apt-get install -y --no-install-recommends gcc curl &&
        pip install --no-cache-dir -r requirements.txt &&
        python run-dev.py
      "
    environment:
      - FLASK_ENV=development
      - SECRET_KEY=dev-secret-key
      - REDIS_URL=redis://:changeme123@redis:6379/0
      - PYTHONUNBUFFERED=1
      - PORT=5000
    ports:
      - "5000:5000"
    volumes:
      - ..:/app
      - pip_cache:/root/.cache/pip
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - distillation-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ---------------------------------------------------------------------------
  # Nginx - Reverse Proxy (Optionnel)
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: distillation-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx-simple.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - web
    networks:
      - distillation-net

volumes:
  redis_data:
    driver: local
  pip_cache:
    driver: local

networks:
  distillation-net:
    driver: bridge